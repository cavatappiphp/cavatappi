<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://docs.cavatappi.dev/walkthrough/02-values/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Values - Cavatappi PHP Framework</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Cavatappi PHP Framework</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../packages/" class="nav-link">Packages</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../roadmap/" class="nav-link">Roadmap</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Walkthrough</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Intro</a>
</li>
                                    
<li>
    <a href="../01-setup/" class="dropdown-item">Setup</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Values</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../01-setup/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/cavatappiphp/cavatappi/edit/main/docs/walkthrough/02-values.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="true">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#_1" class="nav-link"></a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#step-0-figure-out-what-we-need" class="nav-link">Step 0: Figure out what we need</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#step-1-entities" class="nav-link">Step 1: Entities</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#step-2-commands-events" class="nav-link">Step 2: Commands + Events</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#wrapup" class="nav-link">Wrapup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="_1"></h1>
<p>Let's set up some initial Value objects to represent the data we need.</p>
<h2 id="step-0-figure-out-what-we-need">Step 0: Figure out what we need</h2>
<p>A little bit of planning goes a long way. So let me think out loud about what this app will do. I find it easiest to
start with <strong>actions:</strong> what the app will need to do. In this case:</p>
<ol>
<li>User creates a medicine with dosage information.</li>
<li>User updates a medicine with new information.</li>
<li>User records a dose, and the app updates the next dose.</li>
<li>User removes a dose that was incorrectly entered.</li>
<li>User archives a medicine they are no longer taking.</li>
<li>User removes a medicine they no longer need data for.</li>
<li>User un-archives a medicine they are taking again.</li>
</ol>
<p>That's enough for us to define our <em>domain model</em>, the core of the application logic. And we can already see some nouns
and verbs that will guide us to our definitions:</p>
<ol>
<li>Entities (things that are stored and acted on)<ol>
<li>User</li>
<li>Medicine</li>
<li>Dose</li>
</ol>
</li>
<li>Commands (actions that are taken)<ol>
<li>Create Medicine</li>
<li>Update Medicine</li>
<li>Archive Medicine</li>
<li>Restore Medicine (un-archive)</li>
<li>Record Dose</li>
<li>Delete Dose</li>
</ol>
</li>
<li>Events (results of actions)<ol>
<li>Medicine Created</li>
<li>Medicine Updated</li>
<li>Medicine Archived</li>
<li>Medicine Restored</li>
<li>Dose Added</li>
<li>Dose Deleted</li>
</ol>
</li>
</ol>
<p>That looks good to me!</p>
<h2 id="step-1-entities">Step 1: Entities</h2>
<p>An <strong>Entity</strong> in Cavatappi is an object with an <code>id</code>, specifically a UUID from <code>ramsey/uuid</code>. It can be randomly
generated or deterministically generated, but it has an ID.</p>
<p>Our <strong>User</strong> entity is going to look pretty bare for now, as we only need the ID:</p>
<pre><code class="language-php">use Cavatappi\Foundation\DomainEvent\Entity;
use Cavatappi\Foundation\Value;
use Cavatappi\Foundation\Value\ValueKit;
use Ramsey\Uuid\UuidInterface;

readonly class User implements Value, Entity {
    use ValueKit;

    public function __construct(public UuidInterface $id) {}
}
</code></pre>
<p>But this gives us a chance to talk about <code>Value</code>. In Cavatappi, every class is either a <strong>Value</strong> or a <strong>Service.</strong>
Values store information, and Services encapsulate logic. It's how I stick to the <a href="https://en.wikipedia.org/wiki/Single-responsibility_principle">single-responsibility principle</a>.</p>
<p>Value objects <em>should</em> be read-only, but this isn't enforced at the code level. (I tried; it breaks down too easily.)
That's why instead of a superclass, we have an <code>interface</code> and a <code>trait</code> defining three methods:</p>
<ul>
<li><code>with</code> - Creates a clone of the object with the given property changes.</li>
<li><code>equals</code> - Tests the object for equality with the given object, accounting for inconsistencies in properties. (For
   example: if a property is <code>Stringable</code>, it compares the string values instead of the objects themselves.)</li>
<li><code>static reflect</code> - Pulls information from annotations and PHP's type system into a standard format that can be
   modified.</li>
</ul>
<p>Most Value classes will only need to <code>use ValueKit</code> to get all this for free.</p>
<p>Our <strong>Medicine</strong> entity will have a little more data:</p>
<pre><code class="language-php">readonly class Medicine implements Value, Entity, Validated {
    use ValueKit;

    public UuidInterface $id;

    public function __construct(
        public string $name,
        public UuidInterface $userId,
        ?UuidInterface $id = null,
        public ?int $hourlyInterval = null,
        public ?int $dailyLimit = null,
        public bool $alert = false,
        public bool $archived = false,
    ) {
        $this-&gt;id = $id ?? UuidFactory::random();
        $this-&gt;validate();
    }

    public function validate(): void {
        if (isset($this-&gt;hourlyInterval) &amp;&amp; $this-&gt;hourlyInterval &lt;= 0) {
            throw new InvalidValueProperties('Hourly interval must be null or positive.', field: 'hourlyInterval');
        }
        if (isset($this-&gt;dailyLimit) &amp;&amp; $this-&gt;dailyLimit &lt;= 0) {
            throw new InvalidValueProperties('Hourly interval must be null or positive.', field: 'dailyLimit');
        }
    }
}
</code></pre>
<p>Here we're storing a name, the two pieces of timing information, and a couple of flags for application functions. We're
also introducing the <code>Validated</code> interface. Since some scenarios (like serialization or cloning) bypass the constructor,
this breaks validation out into a separate function, <code>validate</code>, that can be called outside of the constructor. <em>We
should still call it within the constructor!</em></p>
<p>We're also adding a default ID. If one isn't provided (a.k.a. this is a new Medicine), the constructor will create one
using <code>UuidFactory</code>, a static class for working with UUIDs inside a Value object.</p>
<p>We'll round it out with <strong>Dose</strong> which is almost as simple as User:</p>
<pre><code class="language-php">readonly class Dose implements Value, Entity {
    use ValueKit;

    public function __construct(
        public UuidInterface $id,
        public UuidInterface $medicineId,
        public DateTimeInterface $timestamp,
    ) {
    }
}
</code></pre>
<h2 id="step-2-commands-events">Step 2: Commands + Events</h2>
<p><strong>Command</strong> and <strong>Event</strong> objects represent input and output to the domain model. Just like a function has parameters
and a return value, a domain model takes command objects and dispatches events with the results. It helps disconnect
our core logic from how our application is built: whether we use a PHP-based frontend or an API, our domain model will
get the same input.</p>
<p>(Plus, it helps define how to test the app, which we <em>are</em> going to do.)</p>
<p>For the sake of brevity, we'll just look at a couple of command/event pairs. First, adding a Medicine:</p>
<pre><code class="language-php">use Cavatappi\Foundation\Command\Authenticated;
use Cavatappi\Foundation\Command\Command;
use Cavatappi\Foundation\Value\ValueKit;
use oddEvan\PillTimer\Entities\Medicine;
use Ramsey\Uuid\UuidInterface;

class AddMedicine implements Command, Authenticated {
    use ValueKit;

    public function __construct(
        public readonly Medicine $medicine,
        public readonly UuidInterface $userId,
    ) {
    }
}
</code></pre>
<p>The class itself is pretty sparse. But doing this allows us to use the validation code we already put in the <code>Medicine</code>
entity class. The <code>AddMedicine</code> command basically says "add this Medicine."</p>
<p>The <code>Authenticated</code> interface requires a <code>userId</code> UUID property. It is assumed that the value of that property is a user
that has been <em>authenticated</em>: that is, their identity has been verified and they are who they say they are, at least
as far as our app is concerned. This authenticated user is the one performing the action, and it's whose <em>authorization</em>
we'll check later.</p>
<p>So why not just use <code>$medicine-&gt;userId</code>? Good question! In this particular case, I'm making it a separate property to
account for potential cases where a user is adding a Medicine for someone else. Maybe it's an import process, or an
administrator making a change. Maybe there's a use-case later on for a family plan? Either way, it feels safer to have
it be a separate property for now.</p>
<p>The corresponding Event looks similar:</p>
<pre><code class="language-php">use Cavatappi\Foundation\DomainEvent\DomainEvent;
use Cavatappi\Foundation\Factories\UuidFactory;
use DateTimeImmutable;
use DateTimeInterface;
use oddEvan\PillTimer\Entities\Medicine;
use Ramsey\Uuid\UuidInterface;

class MedicineAdded implements DomainEvent {
    public readonly UuidInterface $id;
    public readonly DateTimeInterface $timestamp;

    public function __construct(
        public readonly Medicine $medicine,
        public readonly UuidInterface $userId,
        ?UuidInterface $id = null,
        ?DateTimeInterface $timestamp = null,
        public readonly ?UuidInterface $processId = null,
    ) {
        $this-&gt;timestamp = $timestamp ?? new DateTimeImmutable();
        $this-&gt;id = $id ?? UuidFactory::date($this-&gt;timestamp);
    }

    public string $type { get =&gt; self::class; }
    public UuidInterface $entityId { get =&gt; $this-&gt;medicine-&gt;id; }
    public UuidInterface $aggregateId { get =&gt; $this-&gt;medicine-&gt;id; }
}
</code></pre>
<p>This has some added data, mostly to satisfy the <code>DomainEvent</code> interface. There's a lot here, mostly to facilitate
indexing a stream of events:</p>
<ul>
<li><code>entityId</code> is the ID for the entity being affected by this event, in this case the Medicine.</li>
<li><code>aggregateId</code> is the ID for a broader entity or group that this entity is part of. In this case, it's still the
  Medicine.</li>
<li><code>processId</code> is a way to denote events that are linked by a process, such as an import or remote system call.</li>
</ul>
<p>We're also using the <code>UuidFactory::date</code> function to create a
<a href="https://uuid.ramsey.dev/en/stable/rfc4122/version7.html">version 7 UUID</a> since events are created and stored in
sequential order.</p>
<p>To provide a little more context, here's a Command and Event for adding a Dose:</p>
<pre><code class="language-php">readonly class AddDose implements Command, Authenticated {
    use ValueKit;

    public function __construct(
        public Dose $dose,
        public UuidInterface $userId,
    ) {
    }
}
</code></pre>
<pre><code class="language-php">class DoseAdded implements DomainEvent {
    public readonly UuidInterface $id;
    public readonly DateTimeInterface $timestamp;

    public function __construct(
        public readonly Dose $dose,
        public readonly UuidInterface $userId,
        ?UuidInterface $id = null,
        ?DateTimeInterface $timestamp = null,
        public readonly ?UuidInterface $processId = null,
    ) {
        $this-&gt;timestamp = $timestamp ?? new DateTimeImmutable();
        $this-&gt;id = $id ?? UuidFactory::date($this-&gt;timestamp);
    }

    public string $type { get =&gt; self::class; }
    public UuidInterface $entityId { get =&gt; $this-&gt;dose-&gt;id; }
    public UuidInterface $aggregateId { get =&gt; $this-&gt;dose-&gt;medicineId; }
}
</code></pre>
<p>They're very simliar to the Medicine command and event. The most notable difference is while the <code>entityId</code> is the Dose
ID, the <code>aggregateId</code> is still the Medicine ID since that's the "group" the Dose belongs to.</p>
<h2 id="wrapup">Wrapup</h2>
<p>So wait, if the command and event are so similar, why not just combine them? Especially if the command is already
authenticated?</p>
<p>A big part of it is <em>intent.</em> A Command represents something that should happen, while an Event is something that has
happened. In between the two is the domain model code, including <em>authorization.</em> While we know <em>who</em> is making the
request, it is up to the domain model to determine if they <em>can.</em> Not every Command will result in an Event.</p>
<p>As for how similar these Commands and Events are and how they look like copypasta, the very thing this framework wants
to avoid? Well, that's being worked on. Hopefully, as we get closer to version 1, this walkthrough will look a little
different.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Cavatappi PHP Framework &copy; <a href="https://oddevan.com/">Evan Hildreth</a> and contributors. Content licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. Code samples marked for the public domain via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0 1.0</a>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
