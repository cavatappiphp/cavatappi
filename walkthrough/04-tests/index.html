<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://docs.cavatappi.dev/walkthrough/04-tests/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Tests - Cavatappi PHP Framework</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Cavatappi PHP Framework</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../packages/" class="nav-link">Packages</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../roadmap/" class="nav-link">Roadmap</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Walkthrough</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Intro</a>
</li>
                                    
<li>
    <a href="../01-setup/" class="dropdown-item">Setup</a>
</li>
                                    
<li>
    <a href="../02-values/" class="dropdown-item">Values</a>
</li>
                                    
<li>
    <a href="../03-services/" class="dropdown-item">Services</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Tests</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../03-services/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/cavatappiphp/cavatappi/edit/main/docs/walkthrough/04-tests.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="true">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#tests" class="nav-link">Tests</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#step-1-set-up-the-module" class="nav-link">Step 1: Set Up the Module</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#step-2-install-test-utilities" class="nav-link">Step 2: Install Test Utilities</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#step-3-set-up-the-model-test" class="nav-link">Step 3: Set Up the Model Test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#step-4-write-a-model-test" class="nav-link">Step 4: Write a Model Test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#step-5-write-an-app-test" class="nav-link">Step 5: Write an App Test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="tests">Tests</h1>
<p>We all know we should write them. We hardly ever do. One of my hopes with Cavatappi is to make tests easier to write.
Part of that is architecting the application to make it testable, and the other part is having some shortcuts on hand
to make the tests simpler and easier to run.</p>
<h2 id="step-1-set-up-the-module">Step 1: Set Up the Module</h2>
<p>To use some of the shortcuts that Cavatappi has for tests, we'll need to go ahead and set up the Module for our
application. This is a special class that's responsible for providing a list of classes as well as a dependency map for
the services.</p>
<p>There's some useful shortcuts for this as well:</p>
<pre><code class="language-php">use Cavatappi\Foundation\Module;
use Cavatappi\Foundation\Module\FileDiscoveryKit;
use Cavatappi\Foundation\Module\ModuleKit;

class PillTimerBackend implements Module {
    use FileDiscoveryKit;
    use ModuleKit;

    private static function serviceMapOverrides(): array {
        return [];
    }
}
</code></pre>
<p>Not a lot here! Let's take a look at the actual <code>Module</code> interface:</p>
<pre><code class="language-php">interface Module {
    /**
     * Array of class name keys with the interfaces they implement.
     *
     * @return array&lt;class-string, class-string[]&gt;
     */
    public static function discoverableClasses(): array;

    /**
     * Get the Services to be registered in this Model and their dependencies.
     *
     * @return array&lt;class-string, array&lt;string, class-string|callable&gt;|string|callable&gt;
     */
    public static function serviceDependencyMap(): array;
}
</code></pre>
<p>The heavy lifting is done by <code>ModuleKit</code> which implements the two interface methods using a pair of abstract functions:</p>
<pre><code class="language-php">trait ModuleKit {
    //...

    /**
     * Get the list of discoverable classes in this Module.
     *
     * @return class-string[]
     */
    abstract private static function listClasses(): array;

    /**
     * Get any overrides to the autogenerated service dependency map.
     *
     * @return array&lt;class-string, array&lt;string, class-string|callable&gt;|string|callable&gt;
     */
    abstract private static function serviceMapOverrides(): array;

    //...
}
</code></pre>
<p>These take what is unique about your Module and handle the boilerplate:</p>
<ul>
<li><code>listClasses()</code> provides a list of class names in your Module. The trait will add the interfaces the classes implement
  to fulfill the <code>discoverableClasses()</code> requirement.</li>
<li>The trait uses the list of classes to find Service classes and automatically infer a dependency map for them. Any
  that cannot or should not be inferred should be provided in <code>serviceMapOverrides()</code>. The two are merged to fulfill
    the <code>serviceDependencyMap()</code> requirement.</li>
</ul>
<p>For our Module, the <code>listClasses()</code> function is implemented by the <code>FileDiscoveryKit</code> trait. By default, it will
search its own folder and any sub-folders for concrete classes. (Behind the scenes this uses <a href="https://github.com/thephpleague/construct-finder">Construct Finder</a> by
<a href="https://thephpleague.com">The League of Extraordinary Packages</a>.)</p>
<p>We don't currently have any overrides for the dependency map. We might in the future if we have a class that implements
a common interface or requires some configuration that can't be auto-inferred (yet).</p>
<p>With this Module in place, our code is ready to be integrated with a Cavatappi app.</p>
<h2 id="step-2-install-test-utilities">Step 2: Install Test Utilities</h2>
<p>The only required part of this step is declaring the dependency:</p>
<pre><code class="language-shell">composer require --dev cavatappi/testing
</code></pre>
<p>This is going to install a few things including Cavatappi's infrastructure package and <a href="https://phpunit.de">PHPUnit</a>. For convenience,
I'll add a <a href="https://docs.phpunit.de/en/12.4/configuration.html">PHPUnit configuration file</a> and another shortcut in <code>composer.json</code>:</p>
<pre><code class="language-json">  &quot;scripts&quot;: {
    &quot;lint&quot;: &quot;./vendor/squizlabs/php_codesniffer/bin/phpcs&quot;,
    &quot;lintfix&quot;: &quot;./vendor/squizlabs/php_codesniffer/bin/phpcbf&quot;,
    &quot;test&quot;: &quot;phpunit --testsuite unit --no-coverage&quot;
  }
</code></pre>
<p>Finally, I'm going to add a couple of folders. The first, <code>tests</code>, will be where the actual tests go. The second,
<code>test-utils</code>, is going to hold a superclass that will be used by most of the tests. We'll add that to our
<code>composer.json</code> file:</p>
<pre><code class="language-json">  &quot;autoload-dev&quot;: {
    &quot;psr-4&quot;: {
      &quot;oddEvan\\PillTimer\\Test&quot;: &quot;test-utils/&quot;
    }
  }
</code></pre>
<h2 id="step-3-set-up-the-model-test">Step 3: Set Up the Model Test</h2>
<p>Instead of a strict unit test (where we are only testing one specific service class), I'm going to demonstrate testing
the domain model as a whole. Remember that a domain model accepts Command objects and outputs Event objects, and
Cavatappi has a way to test exactly that.</p>
<p>In our <code>test-utils</code> folder, I'll create a base test:</p>
<pre><code class="language-php">use Cavatappi\Test\ModelTest;
use oddEvan\PillTimer\PillTimerBackend;
use oddEvan\PillTimer\Services\DoseRepo;
use oddEvan\PillTimer\Services\MedicineRepo;
use PHPUnit\Framework\MockObject\MockObject;

abstract class PillTimerTest extends ModelTest {
    const INCLUDED_MODELS = [PillTimerBackend::class];

    protected DoseRepo &amp; MockObject $doseRepo;
    protected MedicineRepo &amp; MockObject $medRepo;

    protected function createMockServices(): array {
        $this-&gt;doseRepo = $this-&gt;createMock(DoseRepo::class);
        $this-&gt;medRepo = $this-&gt;createMock(MedicineRepo::class);

        return [
            ...parent::createMockServices(),
            DoseRepo::class =&gt; fn() =&gt; $this-&gt;doseRepo,
            MedicineRepo::class =&gt; fn() =&gt; $this-&gt;medRepo,
        ];
    }
}
</code></pre>
<p>This sets up two mock services for the repository interfaces we created but never implemented. They're class-level
objects, so we can set conditions on each test.</p>
<p>Behind the scenes, Cavatappi will add the result of <code>createMockServices()</code> to the usual output of our <code>PillTimerBackend</code>
Module class as well as its internal test module and create an instance of <code>ServiceRegistry</code>, Cavatappi's dependency
injection container. This way, our tests will confirm that our Module is fully functional as a whole.</p>
<blockquote>
<p>Astute readers will note that we will be writing <em>integration</em> tests and not <em>unit</em> tests. We can get into testing
philosophy whenever, but my personal take is that we are always testing <em>input</em> and <em>results</em>. Which input and which
results should be whatever gives us the most confidence in our code. In the case of a domain model-driven application,
I consider that the Commands and Events. The actual makeup of the services doesn't matter as much as a given command
resulting in the given events.</p>
</blockquote>
<h2 id="step-4-write-a-model-test">Step 4: Write a Model Test</h2>
<p>Enough messing around, let's write a test! We'll start with our <code>AddMedicine</code> Command:</p>
<pre><code class="language-php">use oddEvan\PillTimer\Entities\Medicine;
use oddEvan\PillTimer\Events\MedicineAdded;
use oddEvan\PillTimer\Test\PillTimerTest;

final class AddMedicineTest extends PillTimerTest {
    private Medicine $testMed;

    protected function setUp(): void {
        parent::setUp();

        $this-&gt;testMed = new Medicine(
            name: 'Acetaminophen',
            userId: $this-&gt;randomId(),
            hourlyInterval: 6,
            dailyLimit: 3,
        );
    }

    public function testItCreatesTheMedicine() {
        // Medicine does not already exist.
        $this-&gt;medRepo-&gt;method('has')-&gt;with($this-&gt;testMed-&gt;id)-&gt;willReturn(false);

        $this-&gt;expectEvent(new MedicineAdded(
            medicine: $this-&gt;testMed,
            userId: $this-&gt;testMed-&gt;userId,
        ));

        $this-&gt;app-&gt;execute(new AddMedicine(
            medicine: $this-&gt;testMed,
            userId: $this-&gt;testMed-&gt;userId,
        ));
    }
}
</code></pre>
<p>Not much here, and that's by design! We set up one stub method on our Medicine repository and one expected Event. We
then create the Command and pass it to the test app's <code>execute()</code> method. By using a <code>ModelTest</code> subclass, we already
have a mock set up for <code>EventDispatcherInterface</code> as well as a custom PHPUnit comparator to check that two Event objects
are equal except for their IDs and timestamps.</p>
<p>We can run the test using the shortcut we set up, <code>composer test</code>, and see that it passes:</p>
<pre><code>Add Medicine (oddEvan\PillTimer\Commands\AddMedicine)
 ✔ It creates the medicine
</code></pre>
<h2 id="step-5-write-an-app-test">Step 5: Write an App Test</h2>
<p>Now, what about our <code>NextDoseService</code>? Since it responds to an Event and not a Command, we can't use <code>ModelTest</code>. So for
this one, we'll go up one level to <code>AppTest</code>. We don't need to set up a superclass in this case:</p>
<pre><code class="language-php">use Cavatappi\Test\AppTest;
use DateTimeImmutable;
use oddEvan\PillTimer\Entities\Dose;
use oddEvan\PillTimer\Entities\Medicine;
use oddEvan\PillTimer\Events\DoseAdded;
use oddEvan\PillTimer\PillTimerBackend;
use PHPUnit\Framework\MockObject\MockObject;

final class NextDoseServiceTest extends AppTest {
    const INCLUDED_MODELS = [PillTimerBackend::class];

    protected DoseRepo &amp; MockObject $doseRepo;
    protected MedicineRepo &amp; MockObject $medRepo;

    protected function createMockServices(): array
    {
        $this-&gt;doseRepo = $this-&gt;createMock(DoseRepo::class);
        $this-&gt;medRepo = $this-&gt;createMock(MedicineRepo::class);

        return [
            ...parent::createMockServices(),
            DoseRepo::class =&gt; fn() =&gt; $this-&gt;doseRepo,
            MedicineRepo::class =&gt; fn() =&gt; $this-&gt;medRepo,
        ];
    }

    public function testItCalculatesTheNextDoseCorrectly() {
        $baseTimestamp = new DateTimeImmutable('@' . time(), timezone_open('America/New_York'));

        $medicine = new Medicine(
            name: 'Ibuprofen',
            userId: $this-&gt;randomId(),
            hourlyInterval: 4,
            dailyLimit: 3,
        );
        $this-&gt;medRepo-&gt;method('get')-&gt;with(medicineId: $medicine-&gt;id)-&gt;willReturn($medicine);

        $existingDoses = [];
        $this-&gt;doseRepo-&gt;method('dosesForMedicineInLastDay')-&gt;
            with(medicineId: $medicine-&gt;id)-&gt;willReturn($existingDoses);

        $newDose = new Dose(
            id: $this-&gt;randomId(),
            medicineId: $medicine-&gt;id,
            timestamp: $baseTimestamp,
        );

        $expected = $baseTimestamp-&gt;modify('+4 hours');
        $this-&gt;medRepo-&gt;expects($this-&gt;once())-&gt;method('setNextDose')-&gt;with($medicine-&gt;id, $expected);

        $this-&gt;app-&gt;dispatch(new DoseAdded(
            dose: $newDose,
            userId: $medicine-&gt;userId,
        ));
    }
}
</code></pre>
<p>...there's a lot of copypasta in there. Siri, make a new GitHub issue to refactor ModelTest into a trait.</p>
<p>I've also set this up to eventually refactor the test into something repeatable using <a href="https://docs.phpunit.de/en/12.4/writing-tests-for-phpunit.html#data-providers">PHPUnit's data providers</a>.
This test in particular is going to involve a lot of repetitive set up to make sure that this calculation is being
done correctly. </p>
<p>So that's an overview of how Cavatappi makes testing suck less. And hopefully, as the framework improves, this will
as well!</p>
<hr />
<p>And that's our walkthrough of Cavatappi! We haven't built a complete app yet; there's still more to be done around data
persistence (saving to the database), creating API endpoints, and maybe building an admin UI.</p>
<p>There's more to come, but that's what we have so far. Thanks for reading!</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Cavatappi PHP Framework &copy; <a href="https://oddevan.com/">Evan Hildreth</a> and contributors. Content licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. Code samples marked for the public domain via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0 1.0</a>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
